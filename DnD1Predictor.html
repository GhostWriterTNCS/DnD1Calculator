<html>
<head>
<title>D&D1 Predictor</title>
<style>
td {
    padding-right: 10px;
}

tr {
    vertical-align: top;
}

label {
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome and Opera */
}

input[type=number] {
    width: 70px;
}

.container {
    border-bottom: 1px solid;
    margin-bottom: 1em;
}
</style>
</head>
<body>
<div id='probability' class='container'>
	<h1>Probability</h1> 
	<table><tbody>
		<tr><td>Dice</td><td><input type='number' id='number_of_dice' value='1'/>d<input type='number' id='dice_sides' value='6' /></td></tr>
		<tr><td>
			<select id='type'>
			<option value='=='>exactly (==)</option>
			<option value='>='>at least (>=)</option>
			<option value='<='>at most (<=)</option>
			</select>
		</td><td><input type='number' id='total' value='1'/></td></tr>
		<tr><td>Times</td><td><input type='number' id='times' value='1' /></td></tr>
	</tbody></table>
	<p><input class="json-file-upload" target='probability' type="file" /> <button onclick='exportJSON("probability")'>Export JSON</button><input id='name' placeholder='Name'></input></p>
	<p><button onclick='calculate_probability();'>Calculate</button></p>

	<p>Result: <span id='result'></span></p>
</div>

<div id='expected_damage' class='container'>
	<h1>Expected damage</h1>
	<table><tbody>
		<tr><td>Dice</td><td><input type='number' id='number_of_dice' value='1'/>d<input type='number' id='dice_sides' value='6' /></td></tr>
		<tr><td>Hits</td><td><input type='number' id='hits' value='1' /></td></tr>
	</tbody></table>
	<p><input class="json-file-upload" target='expected_damage' type="file" /> <button onclick='exportJSON("expected_damage")'>Export JSON</button><input id='name' placeholder='Name'></input></p>
	<p><button onclick='calculate_expected_damage();'>Calculate</button></p>

	<p>Result: <span id='result'></span></p>
</div>

<div id='turns_to_defeat' class='container'>
	<h1>A vs B</h1>
	<table><tbody>
	<tr>
		<th>A</th>
		<th>B</th>
	</tr><tr>
		<td>
			<table id='A'><tbody>
				<tr><td>HP</td><td><input type='number' id='hp' value='20'/></td></tr>
				<tr><td>Weapon</td><td><input type='number' id='weapon_number_of_dice' value='1'/>d<input type='number' id='weapon_dice_sides' value='6' /></td></tr>
				<tr><td>TAC0</td><td><input type='number' id='tac0' value='5'/> <label><input type='checkbox' id='always_hit' onclick='document.querySelector("#turns_to_defeat").querySelector("#A").querySelector("#tac0").disabled=this.checked;' />Always hit</label><br/>
				<!--<tr><td>CON</td><td><input type='number' id='con' value='0'/></td></tr>-->
				<tr><td>AC</td><td><input type='number' id='ac' max='9' value='5'/> chance to evade hits (lower is better)</td></tr>		
				<tr><td>Saving throw</td><td><input type='number' id='saving_throw' value='10'/> <label><input type='checkbox' id='no_saving_throw' onclick='document.querySelector("#turns_to_defeat").querySelector("#A").querySelector("#saving_throw").disabled=this.checked;' />No saving throw</label></td></tr>
				<tr><td>Protection</td><td><input type='number' id='protection' value='0'/></td></tr>
				<tr><th>Bonus</th><td></td></tr>
				<tr><td>STR</td><td><input type='number' id='str' min='-3' max='3' value='0'/> bonus to Hit rolls, damage rolls, opening doors</td></tr>
				<tr><td>INT</td><td><input type='number' id='int' min='-3' max='3' value='0'/> bonus to language</td></tr>
				<tr><td>WIS</td><td><input type='number' id='wis' min='-3' max='3' value='0'/> bonus to Saving throws against magic</td></tr>
				<tr><td>DEX</td><td><input type='number' id='dex' min='-3' max='3' value='0'/> bonus to missile fire Hit rolls, Armor Class</td></tr>
				<tr><td>CON</td><td><input type='number' id='con' min='-3' max='3' value='0'/> bonus to Hit point rolls</td></tr>
				<tr><td>CHA</td><td><input type='number' id='cha' min='-3' max='3' value='0'/> bonus to reactions</td></tr>
				<tr><td colspan="2"><input class="json-file-upload" target='A' type="file" /> <button onclick='exportJSON("A")'>Export JSON</button><input id='name' placeholder='Name'></input></td></tr>
			</tbody></table>
		</td>
		<td>
			<table id='B'><tbody>
				<tr><td>HP</td><td><input type='number' id='hp' value='20'/></td></tr>
				<tr><td>Weapon</td><td><input type='number' id='weapon_number_of_dice' value='1'/>d<input type='number' id='weapon_dice_sides' value='6' /></td></tr>
				<tr><td>TAC0</td><td><input type='number' id='tac0' value='5'/> <label><input type='checkbox' id='always_hit' onclick='document.querySelector("#turns_to_defeat").querySelector("#B").querySelector("#tac0").disabled=this.checked;' />Always hit</label><br/>
				<!--<tr><td>CON</td><td><input type='number' id='con' value='0'/></td></tr>-->
				<tr><td>AC</td><td><input type='number' id='ac' max='9' value='5'/> chance to evade hits (lower is better)</td></tr>		
				<tr><td>Saving throw</td><td><input type='number' id='saving_throw' value='10'/> <label><input type='checkbox' id='no_saving_throw' onclick='document.querySelector("#turns_to_defeat").querySelector("#B").querySelector("#saving_throw").disabled=this.checked;' />No saving throw</label></td></tr>
				<tr><td>Protection</td><td><input type='number' id='protection' value='0'/></td></tr>
				<tr><th>Bonus</th><td></td></tr>
				<tr><td>STR</td><td><input type='number' id='str' min='-3' max='3' value='0'/> bonus to Hit rolls, damage rolls, opening doors</td></tr>
				<tr><td>INT</td><td><input type='number' id='int' min='-3' max='3' value='0'/> bonus to language</td></tr>
				<tr><td>WIS</td><td><input type='number' id='wis' min='-3' max='3' value='0'/> bonus to Saving throws against magic</td></tr>
				<tr><td>DEX</td><td><input type='number' id='dex' min='-3' max='3' value='0'/> bonus to missile fire Hit rolls, Armor Class</td></tr>
				<tr><td>CON</td><td><input type='number' id='con' min='-3' max='3' value='0'/> bonus to Hit point rolls</td></tr>
				<tr><td>CHA</td><td><input type='number' id='cha' min='-3' max='3' value='0'/> bonus to reactions</td></tr>
				<tr><td colspan="2"><input class="json-file-upload" target='B' type="file" /> <button onclick='exportJSON("B")'>Export JSON</button><input id='name' placeholder='Name'></input></td></tr>
			</tbody></table>
		</td>
	</tr>
	</tbody></table>
	<p><button onclick='calculate_turns_to_defeat();'>Calculate</button></p>

	<table><tbody>
	<tr>
		<th>A</th>
		<th>B</th>
	</tr><tr>
		<td>
			<div id='result_A'>
				<p>Damage inflicted per turn: <span id='damage'></span></p>
				<p>Turns to defeat B: <span id='result'></span></p>
			</div>
		</td>
		<td>
			<div id='result_B'>
				<p>Damage inflicted per turn: <span id='damage'></span></p>
				<p>Turns to defeat A: <span id='result'></span></p>
			</div>
		</td>
	</tr>
	</tbody></table>
</div>

<div id='attack_on_platoon' class='container'>
	<h1>How many survivors?</h1>
	<p>How many survivors after an attack on a platoon of <input type='number' id='units' value='1'/> units?<p>
	<table><tbody>
	<tr>
		<th>Attack</th>
		<th>Platoon</th>
	</tr><tr>
		<td>
			<table><tbody>
				<tr><td>Weapon</td><td><input type='number' id='weapon_number_of_dice' value='1'/>d<input type='number' id='weapon_dice_sides' value='6' /></td></tr>
				<tr><td>TAC0</td><td><input type='number' id='tac0' value='5'/> <label><input type='checkbox' id='always_hit' onclick='document.querySelector("#attack_on_platoon").querySelector("#tac0").disabled=this.checked;' />Always hit</label></td></tr>
				<tr><th>Bonus</th><td></td></tr>
				<tr><td>STR</td><td><input type='number' id='str' min='-3' max='3' value='0'/> bonus to Hit rolls, damage rolls, opening doors</td></tr>
			</tbody></table>
		</td>
		<td>
			<table><tbody>
				<tr><td>Level</td><td><input type='number' id='level' value='5'/></td></tr>
				<tr><td>AC</td><td><input type='number' id='ac' max='9' value='5'/> chance to evade hits (lower is better)</td></tr>		
				<tr><td>Saving throw</td><td><input type='number' id='saving_throw' value='10'/> <label><input type='checkbox' id='no_saving_throw' onclick='document.querySelector("#attack_on_platoon").querySelector("#saving_throw").disabled=this.checked;' />No saving throw</label></td></tr>
				<tr><td>Protection</td><td><input type='number' id='protection' value='0'/></td></tr>
				<tr><th>Bonus</th><td></td></tr>
				<tr><td>CON</td><td><input type='number' id='con' value='0'/> bonus to Hit point rolls</td></tr>
				<tr><td>DEX</td><td><input type='number' id='dex' min='-3' max='3' value='0'/> bonus to missile Hit rolls, Armor Class</td></tr>
			</tbody></table>
		</td>
	</tr>
	</tbody></table>
	<p><input class="json-file-upload" target='attack_on_platoon' type="file" /> <button onclick='exportJSON("attack_on_platoon")'>Export JSON</button><input id='name' placeholder='Name'></input></p>
	<p><button onclick='calculate_attack_on_platoon();'>Calculate</button></p>

	<p>Damage per unit: <span id='damage'></span></p>
	<p>Result: <span id='result'></span></p>
</div>

<script>
function calculate_probability() {
	var container = document.querySelector('#probability');
	var number_of_dice = get_int(container, 'number_of_dice');
	var dice_sides = get_int(container, 'dice_sides');
	var total = get_int(container, 'total');
	var times = get_int(container, 'times');
	var result = 0;
	switch(container.querySelector('#type').value) {
		case '>=':
			result = dice_prob_at_least(total, number_of_dice, dice_sides);
			break;
		case '<=':
			result = dice_prob_at_most(total, number_of_dice, dice_sides);
			break;
		default:
			result = dice_prob(total, number_of_dice, dice_sides);
			break;
	}
	container.querySelector('#result').innerHTML = percentage(Math.pow(result, times));
}

function calculate_expected_damage() {
	var container = document.querySelector('#expected_damage');
	var number_of_dice = get_int(container, 'number_of_dice');
	var dice_sides = get_int(container, 'dice_sides');
	var hits = get_int(container, 'hits');
	container.querySelector('#result').innerHTML = expected_result(number_of_dice, dice_sides, hits);
}

function calculate_damage_per_turn(weapon_number_of_dice, weapon_dice_sides, str, ac_result, saving_throw, no_saving_throw) {
	var damage_per_turn = (expected_result(weapon_number_of_dice, weapon_dice_sides) + str) * dice_prob_at_least(ac_result, 1, 20);
	if(!no_saving_throw) {
		var saving_throw_result = dice_prob_at_least(saving_throw, 1, 20);
		damage_per_turn = damage_per_turn * (1 - saving_throw_result) + damage_per_turn / 2 * saving_throw_result;
	}
	return damage_per_turn;
}

function calculate_turns_to_defeat() {
	var container = document.querySelector('#turns_to_defeat');
	var container_A = container.querySelector('#A');
	var weapon_number_of_dice_A = get_int(container_A, 'weapon_number_of_dice');
	var weapon_dice_sides_A = get_int(container_A, 'weapon_dice_sides');
	//var con_A = get_int(container_A, 'con');
	var str_A = get_int(container_A, 'str');
	var dex_A = get_int(container_A, 'dex');
	var tac0_A = get_int(container_A, 'tac0');
	
	var hp_A = get_int(container_A, 'hp');
	var ac_A = get_int(container_A, 'ac');
	var protection_A = get_int(container_A, 'protection');
	var saving_throw_A = get_int(container_A, 'saving_throw') - protection_A;
	var no_saving_throw_A = container_A.querySelector('#no_saving_throw').checked;
	var ac_result_A = 0;

	var container_B = container.querySelector('#B');
	var weapon_number_of_dice_B = get_int(container_B, 'weapon_number_of_dice');
	var weapon_dice_sides_B = get_int(container_B, 'weapon_dice_sides');
	//var con_B = get_int(container_B, 'con');
	var str_B = get_int(container_B, 'str');
	var dex_B = get_int(container_B, 'dex');
	var tac0_B = get_int(container_B, 'tac0');
	
	var hp_B = get_int(container_B, 'hp');
	var ac_B = get_int(container_B, 'ac');
	var protection_B = get_int(container_B, 'protection');
	var saving_throw_B = get_int(container_B, 'saving_throw') - protection_B;
	var no_saving_throw_B = container_B.querySelector('#no_saving_throw').checked;
	var ac_result_B = 0;

	if(!container_A.querySelector('#always_hit').checked) {
		ac_result_A = tac0_A - ac_B + dex_B;
	}
	if(!container_B.querySelector('#always_hit').checked) {
		ac_result_B = tac0_B - ac_A + dex_A;
	}

	/*var damage_per_turn = (expected_result(weapon_number_of_dice, weapon_dice_sides) + str) * dice_prob_at_least(ac_result, 1, 20);
	if(!container.querySelector('#no_saving_throw').checked) {
		var saving_throw_result = dice_prob_at_least(saving_throw, 1, 20);
		damage_per_turn = damage_per_turn * (1 - saving_throw_result) + damage_per_turn / 2 * saving_throw_result;
	}*/
	var damage_per_turn_A = calculate_damage_per_turn(weapon_number_of_dice_A, weapon_dice_sides_A, str_A, ac_result_A, saving_throw_B, no_saving_throw_B);
	var damage_per_turn_B = calculate_damage_per_turn(weapon_number_of_dice_B, weapon_dice_sides_B, str_B, ac_result_B, saving_throw_A, no_saving_throw_A);
	container.querySelector('#result_A').querySelector('#damage').innerHTML = damage_per_turn_A;
	container.querySelector('#result_A').querySelector('#result').innerHTML = hp_B / damage_per_turn_A;
	container.querySelector('#result_B').querySelector('#damage').innerHTML = damage_per_turn_B;
	container.querySelector('#result_B').querySelector('#result').innerHTML = hp_A / damage_per_turn_B;
}

function calculate_attack_on_platoon() {
	var container = document.querySelector('#attack_on_platoon');
	var units = get_int(container, 'units');
	
	var weapon_number_of_dice = get_int(container, 'weapon_number_of_dice');
	var weapon_dice_sides = get_int(container, 'weapon_dice_sides');
	var str = get_int(container, 'str');
	var tac0 = get_int(container, 'tac0');
	
	var level = get_int(container, 'level');
	var con = get_int(container, 'con');
	var dex = get_int(container, 'dex');
	var ac = get_int(container, 'ac');
	var protection = get_int(container, 'protection');
	var saving_throw = get_int(container, 'saving_throw') - protection;
	var ac_result = 0;
	if(!container.querySelector('#always_hit').checked) {
		ac_result = tac0 - ac + dex;
	}
	
	var damage_per_unit = (expected_result(weapon_number_of_dice, weapon_dice_sides) + str) * dice_prob_at_least(ac_result, 1, 20);
	var saving_throw_result = dice_prob_at_least(saving_throw, 1, 20);
	damage_per_unit = damage_per_unit * (1 - saving_throw_result) + damage_per_unit / 2 * saving_throw_result;
	container.querySelector('#damage').innerHTML = damage_per_unit;
	var prob_at_least = dice_prob_at_least(damage_per_unit - con * level, level, 8);
	container.querySelector('#result').innerHTML = (units * prob_at_least) + ' survived units (' + percentage(prob_at_least) + ')';
}

function get_int(container, id) {
	//console.log(id + ' => ' + container.querySelector('#' + id).value);
	return parseInt(container.querySelector('#' + id).value);
}

function percentage(num, decimals=2) {
	return (num*100).toFixed(decimals) + '%';
}

// Calculates the expected damage for *n* dice with *s* sides after *h* hits.
function expected_result(n, s, h=1) {
	return n * (s / 2 + 0.5) * h;
}

var factorial_cache = [1, 1];
function factorial(n) {
	if (n < factorial_cache.length) {
		return factorial_cache[n];
	}
	var i = factorial_cache.length;
	var result = factorial_cache[i-1];
	for (i; i <= n; i++) {
		result *= i;
		factorial_cache[i] = result;
	}
	return result;
}

// Calculates the probability for obtaining a given total *p* using *n* dice with *s* sides.
// The function implements the formula described here: http://mathworld.wolfram.com/Dice.html
// and implemented here for Matlab: https://github.com/carlosvega/DiceProbabilities
function dice_prob(p, n, s=6) {
	var k_max = Math.floor((p - n) / s);
	var sum = 0;
	for (var k = 0; k <= k_max; k++) {
		var val1 = Math.pow(-1, k);
		var val2 = comb_sans_repeat(n, k);
		var val3 = comb_sans_repeat(p - (s * k) - 1, n - 1);
		sum = sum + (val1 * val2 * val3);
	}
	return sum / Math.pow(s, n);
}
function comb_sans_repeat(n, k) {
	return factorial(n) / (factorial(k) * factorial(n - k));
}

function dice_prob_at_least(p, n, s=6) {
	var sum = 1;
	for(var i = 0; i < p; i++) {
		sum -= dice_prob(i, n, s);
	}
	return sum;
}

function dice_prob_at_most(p, n, s=6) {
	var sum = 0;
	for(var i = 0; i <= p; i++) {
		sum += dice_prob(i, n, s);
	}
	return sum;
}

/*var number_of_dice = 1;
var dice_sides = 6;
for (var k = 1; k <= number_of_dice * dice_sides; k++) {
	document.getcontainerentById('result').innerHTML += k + ' ' + (dice_prob(k, number_of_dice, dice_sides) * 100).toFixed(2) + '%<br/>';
}
document.getcontainerentById('result').innerHTML += '<br/>At least:<br/>';
for (var k = 1; k <= number_of_dice * dice_sides; k++) {
	document.getcontainerentById('result').innerHTML += k + ' ' + (dice_prob_at_least(k, number_of_dice, dice_sides) * 100).toFixed(2) + '%<br/>';
}
document.getcontainerentById('result').innerHTML += '<br/>At most<br/>';
for (var k = 1; k <= number_of_dice * dice_sides; k++) {
	document.getcontainerentById('result').innerHTML += k + ' ' + (dice_prob_at_most(k, number_of_dice, dice_sides) * 100).toFixed(2) + '%<br/>';
}*/

/**
 * Converts the given data structure to a JSON string.
 * Argument: arr - The data structure that must be converted to JSON
 * Example: var json_string = array2json(['e', {pluribus: 'unum'}]);
 * 			var json = array2json({"success":"Sweet","failure":false,"empty_array":[],"numbers":[1,2,3],"info":{"name":"Binny","site":"http:\/\/www.openjs.com\/"}});
 * http://www.openjs.com/scripts/data/json_encode.php
 */
function array2json(arr) {
    var parts = [];
    var is_list = false; //(Object.prototype.toString.apply(arr) === '[object Array]');

    for(var key in arr) {
    	var value = arr[key];
        if(typeof value == "object") { //Custom handling for arrays
            if(is_list) parts.push(array2json(value)); /* :RECURSION: */
            else parts.push('"' + key + '":' + array2json(value)); /* :RECURSION: */
            //else parts[key] = array2json(value); /* :RECURSION: */
            
        } else {
            var str = "";
            if(!is_list) str = '"' + key + '":';

            //Custom handling for multiple data types
            if(typeof value == "number") str += value; //Numbers
            else if(value === false) str += 'false'; //The booleans
            else if(value === true) str += 'true';
            else str += '"' + value + '"'; //All other things
            // :TODO: Is there any more datatype we should be in the lookout for? (Functions?)

            parts.push(str);
        }
    }
    var json = parts.join(",");
    
    if(is_list) return '[' + json + ']';//Return numerical JSON
    return '{' + json + '}';//Return associative JSON
}

function exportJSON(name) {
	obj = document.querySelector('#' + name);
	var values = new Array();
	[].forEach.call(obj.querySelectorAll('input'), function (elem) {
		console.log(elem.id + " => " + elem.value);
		if (elem.type == 'checkbox') {
			values[elem.id] = elem.checked;
		} else if(elem.id != '') {
			values[elem.id] = elem.value;
		}
	});
	download(values['name'] + ".json", array2json(values));
}

function download(filename, text) {
	var element = document.createElement('a');
	element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
	element.setAttribute('download', filename);

	element.style.display = 'none';
	document.body.appendChild(element);

	element.click();

	document.body.removeChild(element);
}

// Set the value for an element.
function setValue(elem, value) {
	if (elem) {
		if (elem.type && elem.type == 'checkbox') {
			if (value) {
				elem.checked = true;
			} else {
				elem.checked = false;
			}
		} else {
			elem.value = value;
		}
	}
}

// JSON upload handler.
(function () {
	function onChange(event) {
		console.log(event.target);
		var target = event.target.attributes.target.value;
		var file = event.target.files[0];
		var reader = new FileReader();
		reader.onload = (function(f) {
            return function(event) {
				onReaderLoad(event, target);
            };
        })(file);
		reader.readAsText(event.target.files[0]);
	}

	function onReaderLoad(event, target) {
		console.log(event);
		var obj = JSON.parse(event.target.result);
		var parent = document.querySelector('#' + target);
		Object.keys(obj).forEach(function (key) {
			setValue(parent.querySelector('#' + key), obj[key]);
		});
	}

	[].forEach.call(document.querySelectorAll('.json-file-upload'), function (elem) {
		elem.addEventListener('change', onChange);
	});
}());
</script>
</body>
</html>