<html>
<head>
<title>D&D1 Predictor</title>
<style>
tr {
    vertical-align: top;
}

label {
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome and Opera */
}

.container {
    border-bottom: 1px solid;
    margin-bottom: 1em;
}
</style>
</head>
<body>
<div id='probability' class='container'>
	<p>Probability that <input type='number' id='number_of_dice' value='1'/>d<input type='number' id='dice_sides' value='6' /><br />
	is <select id='type'>
		<option value='=='>exactly (==)</option>
		<option value='>='>at least (>=)</option>
		<option value='<='>at most (<=)</option>
	</select> <input type='number' id='total' value='1'/><br />
	<input type='number' id='times' value='1' /> times.<br />
	<button onclick='calculate_1();'>Calculate</button></p>

	<p>Result: <span id='result'></span></p>
</div>

<div id='expected_damage' class='container'>
	Expected damage for <input type='number' id='number_of_dice' value='1'/>d<input type='number' id='dice_sides' value='6' /><br />
	in <input type='number' id='hits' value='1'/> hits.<br />
	<button onclick='calculate_2();'>Calculate</button></p>

	<p>Result: <span id='result'></span></p>
</div>

<div id='turns_to_defeat' class='container'>
	<p>How many turns for A to defeat B</p>
	<table>
	<tbody>
	<tr>
		<th>A</th>
		<th>B</th>
	</tr><tr>
		<td>
			Weapon: <input type='number' id='weapon_number_of_dice' value='1'/>d<input type='number' id='weapon_dice_sides' value='6' /><br />
			STR: <input type='number' id='str' value='0'/><br />
			TAC0: <input type='number' id='tac0' value='5'/> <label><input type='checkbox' id='always_hit' onclick='document.querySelector("#turns_to_defeat").querySelector("#tac0").disabled=this.checked;' />Always hit</label><br/>
		</td>
		<td>
			HP: <input type='number' id='hp' value='20'/><br />
			AC: <input type='number' id='ac' value='5'/><br />
			
		</td>
	</tr>
	</tbody>
	</table>
	<button onclick='calculate_3();'>Calculate</button></p>

	<p>Damage per turn: <span id='damage'></span></p>
	<p>Result: <span id='result'></span></p>
</div>

<script>
function calculate_1() {
	var container = document.querySelector('#probability');
	var number_of_dice = container.querySelector('#number_of_dice').value;
	var dice_sides = container.querySelector('#dice_sides').value;
	var total = container.querySelector('#total').value;
	var times = container.querySelector('#times').value;
	var result = 0;
	switch(container.querySelector('#type').value) {
		case '>=':
			result = dice_prob_at_least(total, number_of_dice, dice_sides);
			break;
		case '<=':
			result = dice_prob_at_most(total, number_of_dice, dice_sides);
			break;
		default:
			result = dice_prob(total, number_of_dice, dice_sides);
			break;
	}
	container.querySelector('#result').innerHTML = percentage(Math.pow(result, times));
}

function calculate_2() {
	var container = document.querySelector('#expected_damage');
	var number_of_dice = container.querySelector('#number_of_dice').value;
	var dice_sides = container.querySelector('#dice_sides').value;
	var hits = container.querySelector('#hits').value;
	container.querySelector('#result').innerHTML = expected_result(number_of_dice, dice_sides, hits);
}

function calculate_3() {
	var container = document.querySelector('#turns_to_defeat');
	var weapon_number_of_dice = container.querySelector('#weapon_number_of_dice').value;
	var weapon_dice_sides = container.querySelector('#weapon_dice_sides').value;
	var str = container.querySelector('#str').value;
	var tac0 = container.querySelector('#tac0').value;
	var hp = container.querySelector('#hp').value;
	var ac = container.querySelector('#ac').value;
	
	var ac_result = tac0 - ac;
	if(container.querySelector('#always_hit').checked) {
		ac_result = 0;
	}
	var damage_per_turn = (expected_result(weapon_number_of_dice, weapon_dice_sides) + str) * dice_prob_at_least(ac_result, 1, 20);
	container.querySelector('#damage').innerHTML = damage_per_turn;
	container.querySelector('#result').innerHTML = hp / damage_per_turn;
}

function percentage(num, decimals=2) {
	return (num*100).toFixed(decimals) + '%';
}

// Calculates the expected damage for *n* dice with *s* sides after *h* hits.
function expected_result(n, s, h=1) {
	return n * (s / 2 + 0.5) * h;
}

var factorial_cache = [1, 1];
function factorial(n) {
	if (n < factorial_cache.length) {
		return factorial_cache[n];
	}
	var i = factorial_cache.length;
	var result = factorial_cache[i-1];
	for (i; i <= n; i++) {
		result *= i;
		factorial_cache[i] = result;
	}
	return result;
}

// Calculates the probability for obtaining a given total *p* using *n* dice with *s* sides.
// The function implements the formula described here: http://mathworld.wolfram.com/Dice.html
// and implemented here for Matlab: https://github.com/carlosvega/DiceProbabilities
function dice_prob(p, n, s=6) {
	var k_max = Math.floor((p - n) / s);
	var sum = 0;
	for (var k = 0; k <= k_max; k++) {
		var val1 = Math.pow(-1, k);
		var val2 = comb_sans_repeat(n, k);
		var val3 = comb_sans_repeat(p - (s * k) - 1, n - 1);
		sum = sum + (val1 * val2 * val3);
	}
	return sum / Math.pow(s, n);
}
function comb_sans_repeat(n, k) {
	return factorial(n) / (factorial(k) * factorial(n - k));
}

function dice_prob_at_least(p, n, s=6) {
	var sum = 1;
	for(var i = 0; i < p; i++) {
		sum -= dice_prob(i, n, s);
	}
	return sum;
}

function dice_prob_at_most(p, n, s=6) {
	var sum = 0;
	for(var i = 0; i <= p; i++) {
		sum += dice_prob(i, n, s);
	}
	return sum;
}

/*var number_of_dice = 1;
var dice_sides = 6;
for (var k = 1; k <= number_of_dice * dice_sides; k++) {
	document.getcontainerentById('result').innerHTML += k + ' ' + (dice_prob(k, number_of_dice, dice_sides) * 100).toFixed(2) + '%<br/>';
}
document.getcontainerentById('result').innerHTML += '<br/>At least:<br/>';
for (var k = 1; k <= number_of_dice * dice_sides; k++) {
	document.getcontainerentById('result').innerHTML += k + ' ' + (dice_prob_at_least(k, number_of_dice, dice_sides) * 100).toFixed(2) + '%<br/>';
}
document.getcontainerentById('result').innerHTML += '<br/>At most<br/>';
for (var k = 1; k <= number_of_dice * dice_sides; k++) {
	document.getcontainerentById('result').innerHTML += k + ' ' + (dice_prob_at_most(k, number_of_dice, dice_sides) * 100).toFixed(2) + '%<br/>';
}*/
</script>
</body>
</html>